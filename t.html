<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShopMart - Product Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    
    .modal.active {
      display: flex !important;
      align-items: center;
      justify-content: center;
    }
    
    .hover-scale:hover {
      transform: scale(1.05);
    }
    
    .transition-all {
      transition: all 0.3s ease;
    }

    /* Ensure images load properly */
    img {
      max-width: 100%;
      height: auto;
    }

    /* Loading animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <!-- Header -->
    <header class="bg-white shadow-md">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
            <svg class="text-indigo-600" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <path d="M16 10a4 4 0 0 1-8 0"></path>
            </svg>
            <h1 class="text-2xl font-bold text-gray-900">ShopMart</h1>
          </div>
          <div class="flex items-center gap-3 flex-wrap">
            <!-- Configuration Display -->
            <div id="configDisplay" class="text-sm text-gray-600" style="display: none;">
              <span class="font-mono font-semibold text-indigo-600" id="currentConfig"></span>
            </div>
            <!-- Admin Settings Button -->
            <button onclick="openAdminModal()" class="flex items-center gap-2 px-4 py-2 text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-all">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6"></path>
                <path d="M5.64 5.64l4.24 4.24m8.48 0l4.24-4.24M5.64 18.36l4.24-4.24m8.48 0l4.24 4.24"></path>
              </svg>
              <span>Admin Settings</span>
            </button>
            <button onclick="goHome()" class="flex items-center gap-2 px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              <span>Home</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Home Page -->
    <div id="homePage" class="flex items-center justify-center min-h-[calc(100vh-100px)] p-4">
      <div class="text-center w-full max-w-4xl">
        <h2 class="text-5xl font-bold text-gray-900 mb-4">
          Welcome to ShopMart
        </h2>
        <p class="text-xl text-gray-600 mb-8">
          Find your favorite products with ease
        </p>
        
        <form onsubmit="handleSearch(event); return false;" class="max-w-2xl mx-auto">
          <div class="relative">
            <input
              type="text"
              id="searchInput"
              placeholder="Search for anything (e.g., laptop, shoes, toys)..."
              class="w-full px-6 py-4 pr-12 text-lg border-2 border-gray-300 rounded-full focus:outline-none focus:border-indigo-500 shadow-lg"
            />
            <button
              type="submit"
              class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 transition-all"
            >
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </button>
          </div>
        </form>

        <div class="mt-8 flex flex-wrap gap-3 justify-center">
          <span class="text-gray-600">Try searching:</span>
          <button
            onclick="quickSearch('shampoo')"
            class="px-4 py-2 bg-white text-indigo-600 rounded-full hover:bg-indigo-100 transition-all shadow"
          >
            shampoo
          </button>
          <button
            onclick="quickSearch('laptop')"
            class="px-4 py-2 bg-white text-indigo-600 rounded-full hover:bg-indigo-100 transition-all shadow"
          >
            laptop
          </button>
          <button
            onclick="quickSearch('shoes')"
            class="px-4 py-2 bg-white text-indigo-600 rounded-full hover:bg-indigo-100 transition-all shadow"
          >
            shoes
          </button>
        </div>
      </div>
    </div>

    <!-- Search Results Page -->
    <div id="resultsPage" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" style="display: none;">
      <!-- Search bar at top -->
      <form onsubmit="handleSearch(event); return false;" class="mb-8">
        <div class="relative max-w-2xl">
          <input
            type="text"
            id="searchInput2"
            placeholder="Search for products..."
            class="w-full px-6 py-3 pr-12 border-2 border-gray-300 rounded-full focus:outline-none focus:border-indigo-500 shadow"
          />
          <button
            type="submit"
            class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 transition-all"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>
        </div>
      </form>

      <!-- Endpoint Status -->
      <div id="endpointStatus" class="mb-4 p-3 rounded-lg text-sm" style="display: none;"></div>

      <!-- Results header -->
      <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-900">
          Search Results for "<span id="searchQuery"></span>"
        </h2>
        <p class="text-gray-600 mt-2">
          <span id="resultCount"></span> products found
        </p>
        <p class="text-sm text-gray-500 mt-1">
          üí° Organic results show demo products. Sponsored products are based on your search term via Criteo API.
        </p>
      </div>

      <!-- Product grid -->
      <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Products will be inserted here -->
      </div>

      <!-- No results message -->
      <div id="noResults" class="text-center py-16" style="display: none;">
        <div class="text-gray-400 mb-4">
          <svg class="mx-auto" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
        <h3 class="text-2xl font-semibold text-gray-900 mb-2">
          No results found
        </h3>
        <p class="text-gray-600 mb-4">
          Try a different search term
        </p>
        <button
          onclick="goHome()"
          class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-all"
        >
          Back to Home
        </button>
      </div>
    </div>

    <!-- Admin Settings Modal -->
    <div id="adminModal" class="modal">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-900">Admin Settings</h3>
          <button onclick="closeAdminModal()" class="text-gray-400 hover:text-gray-600 transition-all">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        
        <div class="space-y-4">
          <!-- Partner ID -->
          <div>
            <label for="partnerIdInput" class="block text-sm font-medium text-gray-700 mb-2">
              Partner ID <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="partnerIdInput"
              placeholder="e.g., 12345"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
            <p class="text-xs text-gray-500 mt-1">
              Required for Criteo delivery endpoint
            </p>
          </div>

          <!-- Data Center Selection -->
          <div>
            <label for="dataCenterSelect" class="block text-sm font-medium text-gray-700 mb-2">
              Select Data Center <span class="text-red-500">*</span>
            </label>
            <select
              id="dataCenterSelect"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
            >
              <option value="as">Asia (as)</option>
              <option value="us">United States (us)</option>
              <option value="eu">Europe (eu)</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">
              Select the appropriate data center region
            </p>
          </div>

          <!-- Page ID -->
          <div>
            <label for="pageIdInput" class="block text-sm font-medium text-gray-700 mb-2">
              Page ID
            </label>
            <input
              type="text"
              id="pageIdInput"
              placeholder="viewSearchResultDesktop"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
            <p class="text-xs text-gray-500 mt-1">
              Default: viewSearchResultDesktop (leave empty to use default)
            </p>
          </div>

          <!-- Info Section -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <div class="flex items-start gap-2">
              <svg class="text-blue-600 flex-shrink-0 mt-0.5" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
              <div class="text-xs text-blue-800">
                <p class="font-semibold mb-1">Auto-generated values:</p>
                <ul class="space-y-1">
                  <li>‚Ä¢ Visitor ID: pid.20250321.{random}</li>
                  <li>‚Ä¢ Customer ID: {random}</li>
                  <li>‚Ä¢ Event Type: viewSearchResult (fixed)</li>
                  <li>‚Ä¢ Keywords: from search query</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="flex gap-3 mt-6">
          <button
            onclick="saveSettings()"
            class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-all font-medium"
          >
            Save Settings
          </button>
          <button
            onclick="clearSettings()"
            class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-all font-medium"
          >
            Clear All
          </button>
        </div>

        <div id="saveMessage" class="mt-4 p-3 rounded-lg text-sm" style="display: none;"></div>
      </div>
    </div>
  </div>

  <script>
    // Product database
    const productDatabase = {
      shampoo: [
        { 
          id: '50616076', 
          name: 'Pantene Pro-V Daily Moisture Renewal Shampoo - 3.38 fl oz', 
          price: 1.99, 
          rating: 4.5, 
          brand: 'Pantene',
          image: 'https://target.scene7.com/is/image/Target/GUEST_4595aa1f-21eb-493d-af74-6ace85a92b8d' 
        },
        { 
          id: '76556194', 
          name: 'Pantene Nutrient Blends Sulfate Free Miracle Moisture Rose Water Shampoo - 9.6 fl oz', 
          price: 9.99, 
          rating: 4.7, 
          brand: 'Pantene',
          image: 'https://target.scene7.com/is/image/Target/GUEST_8bd34486-ad65-4f91-9254-dfa11dacfa33' 
        },
        { 
          id: '79754981', 
          name: 'Pantene Illuminating Sulfate Free Biotin Shampoo for Nourishing Color Safe - 9.6 fl oz', 
          price: 9.99, 
          rating: 4.6, 
          brand: 'Pantene',
          image: 'https://target.scene7.com/is/image/Target/GUEST_8ae2686e-8558-4817-8fc6-b60b616ce218' 
        },
        { 
          id: '83206609', 
          name: 'Pantene Pro-V Smooth & Sleek Shampoo and Conditioner Bundle Pack - 22.4 fl oz', 
          price: 9.49, 
          rating: 4.8, 
          brand: 'Pantene',
          image: 'https://target.scene7.com/is/image/Target/GUEST_db40ada0-3572-4fc2-930c-74a3bf89e554' 
        },
        { 
          id: '83206614', 
          name: 'Pantene Pro-V Smooth & Sleek Shampoo - 23.6 fl oz', 
          price: 8.49, 
          rating: 4.4, 
          brand: 'Pantene',
          image: 'https://target.scene7.com/is/image/Target/GUEST_56028034-de50-46ba-af98-41ccab26a1be' 
        },
        { 
          id: '83206630', 
          name: 'Pantene Pro-V Sheer Volume Shampoo - 23.6 fl oz', 
          price: 8.49, 
          rating: 4.7, 
          brand: 'Pantene',
          image: 'https://target.scene7.com/is/image/Target/GUEST_4be13c6d-261e-4df4-b590-dd2781739a94' 
        },
        { 
          id: '87807092', 
          name: 'Neutrogena Scalp Therapy Itchy Scalp Shampoo - 12 fl oz', 
          price: 10.49, 
          rating: 4.5, 
          brand: 'Neutrogena',
          image: 'https://target.scene7.com/is/image/Target/GUEST_ef53a99e-5f21-420c-844d-08c79cfc4166' 
        },
        { 
          id: '89198869', 
          name: 'Neutrogena Tea & Sal Therapeutic Shampoo - 4.5 fl oz', 
          price: 7.79, 
          rating: 4.3, 
          brand: 'Neutrogena',
          image: 'https://target.scene7.com/is/image/Target/GUEST_c0b1e9d9-37d9-4dca-a1b8-7125ee76b73c' 
        },
        { 
          id: '83206640', 
          name: 'Pantene Pro-V Curl Perfection Shampoo - 23.6 fl oz', 
          price: 8.49, 
          rating: 4.6, 
          brand: 'Pantene',
          image: 'https://target.scene7.com/is/image/Target/GUEST_2a137cf3-c26f-4f4b-804a-88270007f676' 
        },
        { 
          id: '83206643', 
          name: 'Pantene Pro-V Repair & Protect Shampoo - 23.6 fl oz', 
          price: 8.49, 
          rating: 4.8, 
          brand: 'Pantene',
          image: 'https://target.scene7.com/is/image/Target/GUEST_0bac4206-8b25-4dbf-8163-469b3fa97209' 
        },
        { 
          id: '89170363', 
          name: 'Pantene Pro-V Miracles Infinite Lengths Biotin + Collagen Shampoo Sulfate Free - 13.5 fl oz', 
          price: 9.99, 
          rating: 4.9, 
          brand: 'Pantene',
          image: 'https://target.scene7.com/is/image/Target/GUEST_a2bf5a8a-858c-4112-b5b5-a05492424578' 
        },
        { 
          id: '92268141', 
          name: 'Pantene Pro-V Miracles Extreme Damage Shampoo - 13.5 fl oz', 
          price: 9.99, 
          rating: 4.7, 
          brand: 'Pantene',
          image: 'https://target.scene7.com/is/image/Target/GUEST_ad6c5650-3211-4bd2-afd2-3c9a267aa259' 
        },
      ]
    };

    let currentSearchQuery = '';
    let currentResults = [];
    
    // Generate fixed random IDs on page load
    const VISITOR_ID = `pid.20250321.${Math.floor(Math.random() * 10000000000)}`;
    const CUSTOMER_ID = `${Math.floor(Math.random() * 10000000000)}`;

    // Initialize page when DOM is loaded
    function init() {
      console.log('ShopMart initialized');
      console.log('Generated Visitor ID:', VISITOR_ID);
      console.log('Generated Customer ID:', CUSTOMER_ID);
      loadSettings();
    }

    // Navigation functions
    function goHome() {
      console.log('Going home');
      const homePage = document.getElementById('homePage');
      const resultsPage = document.getElementById('resultsPage');
      
      if (homePage && resultsPage) {
        homePage.style.display = 'flex';
        resultsPage.style.display = 'none';
        document.getElementById('searchInput').value = '';
        currentSearchQuery = '';
        currentResults = [];
        sponsoredProducts = [];
      }
    }

    function showResults() {
      console.log('Showing results');
      const homePage = document.getElementById('homePage');
      const resultsPage = document.getElementById('resultsPage');
      
      if (homePage && resultsPage) {
        homePage.style.display = 'none';
        resultsPage.style.display = 'block';
      }
    }

    // Store sponsored products globally
    let sponsoredProducts = [];

    // Criteo Delivery Endpoint
    async function callDeliveryEndpoint(keywords) {
      try {
        const partnerId = localStorage.getItem('partnerId');
        const dataCenter = localStorage.getItem('dataCenter') || 'as';
        const pageId = localStorage.getItem('pageId') || 'viewSearchResultDesktop';
        
        if (!partnerId) {
          console.warn('Partner ID not configured - skipping delivery endpoint call');
          showEndpointStatus('‚ö†Ô∏è Configure Partner ID in Admin Settings to enable tracking', 'warning');
          sponsoredProducts = [];
          return;
        }

        // Construct the delivery endpoint URL
        const endpointUrl = `https://d.${dataCenter}.criteo.com/delivery/retailmedia?` + 
          `criteo-partner-id=${encodeURIComponent(partnerId)}` +
          `&retailer-visitor-id=${encodeURIComponent(VISITOR_ID)}` +
          `&customer-id=${encodeURIComponent(CUSTOMER_ID)}` +
          `&page-id=${encodeURIComponent(pageId)}` +
          `&event-type=viewSearchResult` +
          `&keywords=${encodeURIComponent(keywords)}` +
          `&nolog=1`;

        console.log('%c========================================', 'color: #4F46E5; font-weight: bold');
        console.log('%cCRITEO DELIVERY ENDPOINT REQUEST', 'color: #4F46E5; font-weight: bold; font-size: 14px');
        console.log('%c========================================', 'color: #4F46E5; font-weight: bold');
        console.log('%cFull URL:', 'color: #059669; font-weight: bold');
        console.log(endpointUrl);
        console.log('%cParameters:', 'color: #059669; font-weight: bold');
        console.table({
          'criteo-partner-id': partnerId,
          'retailer-visitor-id': VISITOR_ID,
          'customer-id': CUSTOMER_ID,
          'page-id': pageId,
          'event-type': 'viewSearchResult',
          'keywords': keywords,
          'nolog': '1',
          'data-center': dataCenter
        });
        
        console.log('%cüì§ Sending HTTP GET request...', 'color: #0891B2; font-weight: bold');
        
        // Try regular fetch first
        try {
          const response = await fetch(endpointUrl, {
            method: 'GET',
            mode: 'cors',
            credentials: 'omit'
          });
          
          console.log('%c‚úÖ Response received:', 'color: #059669; font-weight: bold');
          console.log('%cStatus:', 'color: #059669', response.status, response.statusText);
          console.log('%cType:', 'color: #059669', response.type);
          console.log('%cOK:', 'color: #059669', response.ok);
          
          // Try to read response body
          const contentType = response.headers.get('content-type');
          console.log('%cContent-Type:', 'color: #059669', contentType);
          
          if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            console.log('%cResponse Body (JSON):', 'color: #059669');
            console.log(data);
            
            // Parse sponsored products
            sponsoredProducts = parseSponsoredProducts(data);
            console.log('%cüéØ Found ' + sponsoredProducts.length + ' sponsored products', 'color: #059669; font-weight: bold');
            
          } else {
            const text = await response.text();
            console.log('%cResponse Body (Text):', 'color: #059669');
            console.log(text || '(empty response)');
            sponsoredProducts = [];
          }
          
          showEndpointStatus('‚úì Tracking event sent - ' + sponsoredProducts.length + ' sponsored products loaded', 'success');
          
        } catch (corsError) {
          // If CORS fails, fall back to no-cors mode
          console.log('%c‚ö†Ô∏è CORS blocked, using no-cors mode...', 'color: #F59E0B; font-weight: bold');
          console.log('%cCORS Error:', 'color: #F59E0B', corsError.message);
          
          const response = await fetch(endpointUrl, {
            method: 'GET',
            mode: 'no-cors'
          });
          
          console.log('%c‚úì Request sent (no-cors mode):', 'color: #059669; font-weight: bold');
          console.log('%cResponse Type:', 'color: #059669', response.type, '‚Üê opaque is expected');
          console.log('%c‚ÑπÔ∏è Cannot read response in no-cors mode - check Network tab', 'color: #0891B2');
          
          sponsoredProducts = [];
          showEndpointStatus('‚úì Tracking event sent (no-cors mode - sponsored products not available)', 'success');
        }
        
        console.log('%c========================================', 'color: #4F46E5; font-weight: bold');
        
      } catch (error) {
        console.log('%c========================================', 'color: #DC2626; font-weight: bold');
        console.log('%c‚ùå ERROR CALLING ENDPOINT', 'color: #DC2626; font-weight: bold; font-size: 14px');
        console.log('%c========================================', 'color: #DC2626; font-weight: bold');
        console.error('Error details:', error);
        console.log('Error name:', error.name);
        console.log('Error message:', error.message);
        console.log('Error stack:', error.stack);
        console.log('%c========================================', 'color: #DC2626; font-weight: bold');
        sponsoredProducts = [];
        showEndpointStatus('‚ö†Ô∏è Error sending tracking event: ' + error.message, 'error');
      }
    }

    // Parse sponsored products from Criteo response
    function parseSponsoredProducts(data) {
      const products = [];
      
      try {
        if (!data || !data.placements) {
          console.log('%c‚ö†Ô∏è No placements in response', 'color: #F59E0B');
          return products;
        }
        
        // Loop through placements array
        data.placements.forEach((placement, placementIndex) => {
          console.log(`%cProcessing placement ${placementIndex}:`, 'color: #0891B2', placement);
          
          // Each placement is an object with keys like "viewSearchResultDesktop-searchSP"
          Object.keys(placement).forEach(placementKey => {
            const placementData = placement[placementKey];
            console.log(`  Placement key: ${placementKey}`, placementData);
            
            // placementData is an array
            if (Array.isArray(placementData)) {
              placementData.forEach((item, itemIndex) => {
                console.log(`    Item ${itemIndex}:`, item);
                
                // Check if this is sponsored_products format
                if (item.format === 'sponsored_products' && item.products) {
                  console.log(`    ‚úì Found sponsored_products with ${item.products.length} products`);
                  
                  // Add each product to our array
                  item.products.forEach(product => {
                    products.push({
                      id: product.ProductId,
                      name: product.ProductName,
                      price: parseFloat(product.Price),
                      comparePrice: parseFloat(product.ComparePrice),
                      rating: parseFloat(product.Rating) > 0 ? parseFloat(product.Rating) : 4.5,
                      brand: extractBrand(product),
                      image: product.Image,
                      productPage: product.ProductPage,
                      isSponsored: true,
                      onClickBeacon: product.OnClickBeacon,
                      onViewBeacon: product.OnViewBeacon
                    });
                  });
                }
              });
            }
          });
        });
        
        console.log('%c‚úì Parsed ' + products.length + ' sponsored products total', 'color: #059669; font-weight: bold');
        
      } catch (error) {
        console.error('Error parsing sponsored products:', error);
      }
      
      return products;
    }

    // Extract brand from RenderingAttributes
    function extractBrand(product) {
      try {
        if (product.RenderingAttributes) {
          const attrs = JSON.parse(product.RenderingAttributes);
          return attrs.brand || 'Sponsored';
        }
      } catch (e) {
        console.warn('Could not parse RenderingAttributes:', e);
      }
      return 'Sponsored';
    }

    function showEndpointStatus(message, type) {
      const statusDiv = document.getElementById('endpointStatus');
      if (!statusDiv) return;
      
      const colorClasses = {
        success: 'bg-green-100 text-green-800 border border-green-200',
        warning: 'bg-yellow-100 text-yellow-800 border border-yellow-200',
        error: 'bg-red-100 text-red-800 border border-red-200'
      };
      
      statusDiv.textContent = message;
      statusDiv.className = `mb-4 p-3 rounded-lg text-sm ${colorClasses[type] || ''}`;
      statusDiv.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    // Search functionality
    async function handleSearch(event) {
      if (event) {
        event.preventDefault();
      }
      
      const input = document.getElementById('searchInput').value || document.getElementById('searchInput2').value;
      const query = input.toLowerCase().trim();
      
      console.log('Searching for:', query);
      
      if (query) {
        currentSearchQuery = query;
        
        // Always show shampoo products as organic results regardless of search term
        currentResults = productDatabase['shampoo'] || [];
        console.log('Found organic results (always shampoo):', currentResults.length);
        
        // Call Criteo delivery endpoint with actual search term
        console.log('Calling Criteo with search term:', query);
        await callDeliveryEndpoint(query);
        
        // Now display results with both organic and sponsored products
        displayResults();
      }
      
      return false;
    }

    async function quickSearch(keyword) {
      console.log('Quick search for:', keyword);
      currentSearchQuery = keyword;
      
      // Always show shampoo products as organic results
      currentResults = productDatabase['shampoo'] || [];
      
      // Call Criteo delivery endpoint with actual keyword
      await callDeliveryEndpoint(keyword);
      
      displayResults();
    }

    function displayResults() {
      showResults();
      
      const searchQueryEl = document.getElementById('searchQuery');
      const searchInput2 = document.getElementById('searchInput2');
      const resultCountEl = document.getElementById('resultCount');
      const productGrid = document.getElementById('productGrid');
      const noResults = document.getElementById('noResults');
      
      if (searchQueryEl) searchQueryEl.textContent = currentSearchQuery;
      if (searchInput2) searchInput2.value = currentSearchQuery;
      
      // Merge sponsored products with organic results
      // Put sponsored products first
      const allProducts = [...sponsoredProducts, ...currentResults];
      const totalCount = allProducts.length;
      
      if (resultCountEl) {
        const sponsoredCount = sponsoredProducts.length;
        const organicCount = currentResults.length;
        if (sponsoredCount > 0) {
          resultCountEl.innerHTML = `${totalCount} products found <span class="text-sm text-gray-500">(${sponsoredCount} sponsored, ${organicCount} organic)</span>`;
        } else {
          resultCountEl.textContent = totalCount + ' products found';
        }
      }

      if (allProducts.length > 0) {
        if (productGrid) {
          productGrid.style.display = 'grid';
          productGrid.innerHTML = allProducts.map(product => createProductCard(product)).join('');
          
          // Fire view beacons for sponsored products after rendering
          fireViewBeacons();
        }
        if (noResults) noResults.style.display = 'none';
      } else {
        if (productGrid) productGrid.style.display = 'none';
        if (noResults) noResults.style.display = 'block';
      }
    }

    // Fire view beacons for sponsored products
    function fireViewBeacons() {
      sponsoredProducts.forEach(product => {
        if (product.onViewBeacon) {
          const img = new Image();
          img.src = product.onViewBeacon;
          console.log('%cüëÅÔ∏è View beacon fired for:', 'color: #8B5CF6', product.name);
        }
      });
    }

    function createProductCard(product) {
      const stars = renderStars(product.rating);
      const isSponsored = product.isSponsored || false;
      
      // For sponsored products, use the ProductPage with click tracking
      const productClickHandler = isSponsored 
        ? `handleSponsoredClick('${product.id}', '${encodeURIComponent(product.productPage)}', '${encodeURIComponent(product.onClickBeacon || '')}')`
        : `alert('View product: ${product.name}')`;
      
      const sponsoredBadge = isSponsored 
        ? `<div class="absolute top-2 right-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full shadow-md">
             SPONSORED
           </div>`
        : '';
      
      const borderClass = isSponsored 
        ? 'border-2 border-yellow-400' 
        : '';
      
      return `
        <div class="bg-white rounded-lg shadow-md hover:shadow-xl transition-all cursor-pointer overflow-hidden relative ${borderClass}" 
             onclick="${productClickHandler}">
          ${sponsoredBadge}
          <div class="aspect-square overflow-hidden bg-gray-100">
            <img
              src="${product.image}"
              alt="${product.name}"
              class="w-full h-full object-cover hover:scale-110 transition-all duration-300"
              onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23ddd%22 width=%22200%22 height=%22200%22/%3E%3Ctext fill=%22%23999%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3ENo Image%3C/text%3E%3C/svg%3E'"
            />
          </div>
          <div class="p-4">
            <div class="mb-2">
              <span class="text-xs font-semibold ${isSponsored ? 'text-yellow-600 bg-yellow-50' : 'text-indigo-600 bg-indigo-50'} px-2 py-1 rounded">
                ${product.brand}
              </span>
            </div>
            <h3 class="font-semibold text-lg text-gray-900 mb-2 line-clamp-2">
              ${product.name}
            </h3>
            <div class="mb-2">
              ${stars}
            </div>
            <div class="flex items-center justify-between">
              <span class="text-2xl font-bold ${isSponsored ? 'text-yellow-600' : 'text-indigo-600'}">
                $${product.price.toFixed(2)}
              </span>
              <button class="${isSponsored ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-indigo-600 hover:bg-indigo-700'} text-white px-4 py-2 rounded-lg transition-all text-sm" 
                      onclick="event.stopPropagation(); alert('Added to cart!')">
                Add to Cart
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Handle sponsored product clicks with beacon tracking
    function handleSponsoredClick(productId, productPageUrl, clickBeaconUrl) {
      console.log('%cüñ±Ô∏è Sponsored product clicked:', 'color: #8B5CF6; font-weight: bold', productId);
      
      // Fire click beacon if available
      if (clickBeaconUrl) {
        const decodedBeacon = decodeURIComponent(clickBeaconUrl);
        const img = new Image();
        img.src = decodedBeacon;
        console.log('%cüìä Click beacon fired:', 'color: #8B5CF6', decodedBeacon);
      }
      
      // Redirect to product page
      if (productPageUrl) {
        const decodedUrl = decodeURIComponent(productPageUrl);
        console.log('%cüîó Redirecting to:', 'color: #8B5CF6', decodedUrl);
        window.open(decodedUrl, '_blank');
      }
    }

    function renderStars(rating) {
      const fullStars = Math.floor(rating);
      let starsHtml = '<div class="flex items-center gap-1">';
      
      for (let i = 0; i < 5; i++) {
        if (i < fullStars) {
          starsHtml += `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="#FBBF24" stroke="#FBBF24" stroke-width="2">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
          `;
        } else {
          starsHtml += `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#D1D5DB" stroke-width="2">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
          `;
        }
      }
      
      starsHtml += `<span class="text-sm text-gray-600 ml-1">${rating}</span></div>`;
      return starsHtml;
    }

    // Admin Modal Functions
    function openAdminModal() {
      console.log('Opening admin modal');
      const modal = document.getElementById('adminModal');
      if (modal) {
        modal.classList.add('active');
        loadSettingsToInputs();
      }
    }

    function closeAdminModal() {
      console.log('Closing admin modal');
      const modal = document.getElementById('adminModal');
      const saveMessage = document.getElementById('saveMessage');
      
      if (modal) {
        modal.classList.remove('active');
      }
      if (saveMessage) {
        saveMessage.style.display = 'none';
      }
    }

    function loadSettingsToInputs() {
      try {
        const partnerId = localStorage.getItem('partnerId');
        const dataCenter = localStorage.getItem('dataCenter');
        const pageId = localStorage.getItem('pageId');
        
        const partnerIdInput = document.getElementById('partnerIdInput');
        const dataCenterSelect = document.getElementById('dataCenterSelect');
        const pageIdInput = document.getElementById('pageIdInput');
        
        if (partnerId && partnerIdInput) {
          partnerIdInput.value = partnerId;
        }
        if (dataCenter && dataCenterSelect) {
          dataCenterSelect.value = dataCenter;
        }
        if (pageId && pageIdInput) {
          pageIdInput.value = pageId;
        }
      } catch (e) {
        console.warn('localStorage not available:', e);
      }
    }

    function saveSettings() {
      const partnerIdInput = document.getElementById('partnerIdInput');
      const dataCenterSelect = document.getElementById('dataCenterSelect');
      const pageIdInput = document.getElementById('pageIdInput');
      const messageDiv = document.getElementById('saveMessage');
      
      if (!partnerIdInput || !dataCenterSelect || !messageDiv) return;
      
      const partnerId = partnerIdInput.value.trim();
      const dataCenter = dataCenterSelect.value;
      const pageId = pageIdInput.value.trim() || 'viewSearchResultDesktop';
      
      if (!partnerId) {
        messageDiv.textContent = '‚ö†Ô∏è Partner ID is required';
        messageDiv.className = 'mt-4 p-3 rounded-lg text-sm bg-yellow-100 text-yellow-800';
        messageDiv.style.display = 'block';
        return;
      }
      
      try {
        localStorage.setItem('partnerId', partnerId);
        localStorage.setItem('dataCenter', dataCenter);
        localStorage.setItem('pageId', pageId);
        
        messageDiv.textContent = '‚úì Settings saved successfully!';
        messageDiv.className = 'mt-4 p-3 rounded-lg text-sm bg-green-100 text-green-800';
        messageDiv.style.display = 'block';
        
        // Update display
        updateConfigDisplay();
        
        // Log the configuration
        console.log('Configuration saved:', {
          partnerId,
          dataCenter,
          pageId,
          visitorId: VISITOR_ID,
          customerId: CUSTOMER_ID
        });
        
        // Close modal after 1.5 seconds
        setTimeout(() => {
          closeAdminModal();
        }, 1500);
      } catch (e) {
        console.error('Error saving to localStorage:', e);
        messageDiv.textContent = '‚ö†Ô∏è Error saving settings';
        messageDiv.className = 'mt-4 p-3 rounded-lg text-sm bg-red-100 text-red-800';
        messageDiv.style.display = 'block';
      }
    }

    function clearSettings() {
      const partnerIdInput = document.getElementById('partnerIdInput');
      const dataCenterSelect = document.getElementById('dataCenterSelect');
      const pageIdInput = document.getElementById('pageIdInput');
      const messageDiv = document.getElementById('saveMessage');
      
      if (!messageDiv) return;
      
      try {
        localStorage.removeItem('partnerId');
        localStorage.removeItem('dataCenter');
        localStorage.removeItem('pageId');
        
        if (partnerIdInput) partnerIdInput.value = '';
        if (dataCenterSelect) dataCenterSelect.value = 'as';
        if (pageIdInput) pageIdInput.value = '';
        
        messageDiv.textContent = 'Settings cleared';
        messageDiv.className = 'mt-4 p-3 rounded-lg text-sm bg-gray-100 text-gray-800';
        messageDiv.style.display = 'block';
        
        // Update display
        updateConfigDisplay();
        
        // Close modal after 1.5 seconds
        setTimeout(() => {
          closeAdminModal();
        }, 1500);
      } catch (e) {
        console.error('Error clearing localStorage:', e);
      }
    }

    function loadSettings() {
      updateConfigDisplay();
    }

    function updateConfigDisplay() {
      try {
        const partnerId = localStorage.getItem('partnerId');
        const dataCenter = localStorage.getItem('dataCenter');
        const displayDiv = document.getElementById('configDisplay');
        const configSpan = document.getElementById('currentConfig');
        
        if (displayDiv && configSpan) {
          if (partnerId) {
            configSpan.textContent = `Partner: ${partnerId} | DC: ${dataCenter || 'as'}`;
            displayDiv.style.display = 'block';
          } else {
            displayDiv.style.display = 'none';
          }
        }
      } catch (e) {
        console.warn('localStorage not available:', e);
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('adminModal');
      if (modal && event.target === modal) {
        closeAdminModal();
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Log that script loaded
    console.log('ShopMart with Criteo integration loaded successfully');
  </script>
</body>
</html>